/*****************************************************************************/
/*                                                  ###                      */
/*       #####          ###    ###                  ###  CREATE: 2010-10-19  */
/*     #######          ###    ###      [KRNL]      ###  ~~~~~~~~~~~~~~~~~~  */
/*    ########          ###    ###                  ###  MODIFY: XXXX-XX-XX  */
/*    ####  ##          ###    ###                  ###  ~~~~~~~~~~~~~~~~~~  */
/*   ###       ### ###  ###    ###    ####    ####  ###   ##  +-----------+  */
/*  ####       ######## ##########  #######  ###### ###  ###  |  A NEW C  |  */
/*  ###        ######## ########## ########  ###### ### ###   | FRAMEWORK |  */
/*  ###     ## #### ### ########## ###  ### ###     ######    |  FOR ALL  |  */
/*  ####   ### ###  ### ###    ### ###  ### ###     ######    | PLATFORMS |  */
/*  ########## ###      ###    ### ######## ####### #######   |  AND ALL  |  */
/*   #######   ###      ###    ### ########  ###### ###  ###  | COMPILERS |  */
/*    #####    ###      ###    ###  #### ##   ####  ###   ##  +-----------+  */
/*  =======================================================================  */
/*  >>>>>>>>>>>>>>>>>>>>> CrHack MCS-51 片上功能函数库 <<<<<<<<<<<<<<<<<<<<  */
/*  =======================================================================  */
/*****************************************************************************/

#include "fw-mcs51.h"

/*****************************************************************************/
/*                                UART 设备                                  */
/*****************************************************************************/

#if !defined(__no_uart0_init)

/* 定时器初值查表 */
static const byte_t _rom_ s_const0[] =
{
#if     (UART0_FOSC == 500000UL)
    0x72, 0,    /*    110 */
    0xCC, 0,    /*    300 */
    0xE6, 0,    /*    600 */
    0xF3, 0,    /*   1200 */
    0xF3, 1,    /*   2400 */
#elif   (UART0_FOSC == 921600UL)
    0xA0, 0,    /*    300 */
    0xD0, 0,    /*    600 */
    0xE8, 0,    /*   1200 */
    0xF4, 0,    /*   2400 */
    0xFA, 0,    /*   4800 */
    0xFD, 0,    /*   9600 */
    0xFE, 0,    /*  14400 */
    0xFD, 1,    /*  19200 */
    0xFF, 1,    /*  57600 */
#elif   (UART0_FOSC == 1000000UL)
    0x98, 0,    /*    300 */
    0xCC, 0,    /*    600 */
    0xE6, 0,    /*   1200 */
    0xF3, 0,    /*   2400 */
    0xF3, 1,    /*   4800 */
#elif   (UART0_FOSC == 1843200UL)
    0x40, 0,    /*    300 */
    0xA0, 0,    /*    600 */
    0xD0, 0,    /*   1200 */
    0xE8, 0,    /*   2400 */
    0xF4, 0,    /*   4800 */
    0xFA, 0,    /*   9600 */
    0xFC, 0,    /*  14400 */
    0xFD, 0,    /*  19200 */
    0xFD, 1,    /*  38400 */
    0xFF, 0,    /*  57600 */
    0xFF, 1,    /* 115200 */
#elif   (UART0_FOSC == 2000000UL)
    0x30, 0,    /*    300 */
    0x98, 0,    /*    600 */
    0xCC, 0,    /*   1200 */
    0xE6, 0,    /*   2400 */
    0xF3, 0,    /*   4800 */
    0xF3, 1,    /*   9600 */
#elif   (UART0_FOSC == 3686400UL)
    0x40, 0,    /*    600 */
    0xA0, 0,    /*   1200 */
    0xD0, 0,    /*   2400 */
    0xE8, 0,    /*   4800 */
    0xF4, 0,    /*   9600 */
    0xF8, 0,    /*  14400 */
    0xFA, 0,    /*  19200 */
    0xFD, 0,    /*  38400 */
    0xFE, 0,    /*  57600 */
    0xFF, 0,    /* 115200 */
#elif   (UART0_FOSC == 6000000UL)
    0x64, 0,    /*   1200 */
    0xB2, 0,    /*   2400 */
    0xD9, 0,    /*   4800 */
    0xD9, 1,    /*   9600 */
    0xF3, 0,    /*  14400 */
#elif   (UART0_FOSC == 11059200UL)
    0x70, 0,    /*   2400 */
    0xB8, 0,    /*   4800 */
    0xDC, 0,    /*   9600 */
    0xE8, 0,    /*  14400 */
    0xEE, 0,    /*  19200 */
    0xF7, 0,    /*  38400 */
    0xFA, 0,    /*  57600 */
    0xFD, 0,    /* 115200 */
#elif   (UART0_FOSC == 12000000UL)
    0x64, 0,    /*   2400 */
    0xB2, 0,    /*   4800 */
    0xD9, 0,    /*   9600 */
    0xE6, 0,    /*  14400 */
    0xD9, 1,    /*  19200 */
    0xF3, 1,    /*  57600 */
#elif   (UART0_FOSC == 22118400UL)
    0x70, 0,    /*   4800 */
    0xB8, 0,    /*   9600 */
    0xD0, 0,    /*  14400 */
    0xDC, 0,    /*  19200 */
    0xEE, 0,    /*  38400 */
    0xF4, 0,    /*  57600 */
    0xFA, 0,    /* 115200 */
    0xF5, 1,    /* 128000 */
#elif   (UART0_FOSC == 24000000UL)
    0x64, 0,    /*   4800 */
    0xB2, 0,    /*   9600 */
    0xCC, 0,    /*  14400 */
    0xD9, 0,    /*  19200 */
    0xD9, 1,    /*  38400 */
    0xF3, 0,    /*  57600 */
    0xF3, 1,    /* 115200 */
#endif
};

/*
=======================================
    异步串口0初始化
=======================================
*/
CR_API bool_t
uart0_init (
  __CR_IN__ byte_t  baud,
  __CR_IN__ bool_t  parity
    )
{
    /* 关闭定时器 */
    if (baud > cntsof(s_const0) / 2)
        return (FALSE);
    r_TCON &= 0x3F;

    /* 设置波特率 */
    baud <<= 1;
    if (s_const0[baud + 1])
        r_PCON |= 0x80;
    else
        r_PCON &= 0x7F;
    r_TH1 = s_const0[baud];

    /* 打开定时器 */
    r_TMOD &= 0x0F;
    r_TMOD |= 0x20;
    if (!parity)
        r_SCON = 0x70;  /* 0x50; */
    else
        r_SCON = 0xD0;
    r_TL1 = r_TH1;
    b_TR1 = 1;
    return (TRUE);
}

#endif  /* !__no_uart0_init */

#if !defined(__no_uart0_read)
/*
=======================================
    异步串口0读取数据 (阻塞式)
=======================================
*/
CR_API void_t
uart0_read (
  __CR_OT__ void_t* data,
  __CR_IN__ leng_t  size
    )
{
    for (; size != 0; size--) {
        while (!b_RI); b_RI = 0;
        *(byte_t*)data = r_SBUF;
        data = (byte_t*)data + 1;
    }
}

#endif  /* !__no_uart0_read */

#if !defined(__no_uart0_write)
/*
=======================================
    异步串口0写入数据 (阻塞式)
=======================================
*/
CR_API void_t
uart0_write (
  __CR_IN__ const void_t*   data,
  __CR_IN__ leng_t          size
    )
{
    for (; size != 0; size--) {
        r_SBUF = *(byte_t*)data;
        data = (byte_t*)data + 1;
        while (!b_TI); b_TI = 0;
    }
}

#endif  /* !__no_uart0_write */

/*****************************************************************************/
/* _________________________________________________________________________ */
/* uBMAzRBoAKAHaACQD6FoAIAPqbgA/7rIA+5CM9uKw8D4Au7u7mSIJ0t18mYz0mYz9rAQZCgHc */
/* wRIZIgHZovGBXUAZg+v0GbB+gRmgcJ7BAAAisIlAwB1Av7LSHUC/s9IdQL+w0h1Av7HZkZmgf */
/* 4JLgIAdb262gPsqAh0+zP/uQB9ZYsFZYktq+L3sMi/AAK7gAKJAUtLdfq5IANXvT8BiQzfBIv */
/* FLaAAweAEmff53wb+Adjx3kQE2xwy5Io8ithkigcFgACJBN8E3sneNvwB2xyLHDkdfA2JHSyA */
/* adtAAQPdZYgHR0dNdbZfSYP5UHWr/kQEtAHNFg+Eef/DWAKgDw== |~~~~~~~~~~~~~~~~~~~ */
/* ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ >>> END OF FILE <<< */
/*****************************************************************************/
