/*****************************************************************************/
/*                                                  ###                      */
/*       #####          ###    ###                  ###  CREATE: 2012-01-13  */
/*     #######          ###    ###      [MATH]      ###  ~~~~~~~~~~~~~~~~~~  */
/*    ########          ###    ###                  ###  MODIFY: XXXX-XX-XX  */
/*    ####  ##          ###    ###                  ###  ~~~~~~~~~~~~~~~~~~  */
/*   ###       ### ###  ###    ###    ####    ####  ###   ##  +-----------+  */
/*  ####       ######## ##########  #######  ###### ###  ###  |  A NEW C  |  */
/*  ###        ######## ########## ########  ###### ### ###   | FRAMEWORK |  */
/*  ###     ## #### ### ########## ###  ### ###     ######    |  FOR ALL  |  */
/*  ####   ### ###  ### ###    ### ###  ### ###     ######    | PLATFORMS |  */
/*  ########## ###      ###    ### ######## ####### #######   |  AND ALL  |  */
/*   #######   ###      ###    ### ########  ###### ###  ###  | COMPILERS |  */
/*    #####    ###      ###    ###  #### ##   ####  ###   ##  +-----------+  */
/*  =======================================================================  */
/*  >>>>>>>>>>>>>>>>>>>>> CrHack IAPWS-IF97 三区函数库 <<<<<<<<<<<<<<<<<<<<  */
/*  =======================================================================  */
/*****************************************************************************/

#include "phylib.h"

#ifndef _CR_NO_STDC_
    #include <math.h>
#endif

/* IAPWS-IF97 三区（临界区）计算常数表 */
static const sint_t _rom_ s_iif97_ii[40] =
{
    0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 3, 3, 3,
    3, 3, 4, 4, 4, 4, 5, 5, 5, 6, 6, 6, 7, 8, 9, 9, 10, 10, 11,
};

static const sint_t _rom_ s_iif97_ji[40] =
{
    0, 0, 1, 2, 7, 10, 12, 23, 2, 6, 15, 17, 0, 2, 6, 7, 22, 26, 0,
    2, 4, 16, 26, 0, 2, 4, 26, 1, 3, 26, 0, 2, 26, 2, 26, 2, 26, 0,
    1, 26,
};

static const double _rom_ s_iif97_ni[40] =
{
     0.10658070028513E+01, -0.15732845290239E+02,  0.20944396974307E+02,
    -0.76867707878716E+01,  0.26185947787954E+01, -0.28080781148620E+01,
     0.12053369696517E+01, -0.84566812812502E-02, -0.12654315477714E+01,
    -0.11524407806681E+01,  0.88521043984318E+00, -0.64207765181607E+00,
     0.38493460186671E+00, -0.85214708824206E+00,  0.48972281541877E+01,
    -0.30502617256965E+01,  0.39420536879154E-01,  0.12558408424308E+00,
    -0.27999329698710E+00,  0.13899799569460E+01, -0.20189915023570E+01,
    -0.82147637173963E-02, -0.47596035734923E+00,  0.43984074473500E-01,
    -0.44476435428739E+00,  0.90572070719733E+00,  0.70522450087967E+00,
     0.10770512626332E+00, -0.32913623258954E+00, -0.50871062041158E+00,
    -0.22175400873096E-01,  0.94260751665092E-01,  0.16436278447961E+00,
    -0.13503372241348E-01, -0.14834345352472E-01,  0.57922953628084E-03,
     0.32308904703711E-02,  0.80964802996215E-04, -0.16557679795037E-03,
    -0.44923899061815E-04,
};

/*
=======================================
    IAPWS-IF97 三区压力计算
=======================================
*/
CR_API double
iif97_3_ws_p (
  __CR_IN__ double  t,
  __CR_IN__ double  cp
    )
{
    double  xx;
    double  cpp;
    double  vvv;
    ufast_t idx;

    t += 273.15;
    cpp = cp / 322.0;
    xx = s_iif97_ni[0];
    for (vvv = 647.096 / t, idx = 1; idx < 40; idx++) {
        xx += s_iif97_ni[idx] * s_iif97_ii[idx] *
                  pow(cpp, s_iif97_ii[idx]) *
                  pow(vvv, s_iif97_ji[idx]);
    }
    return (0.461526 / 1000.0 * cp * t * xx);
}

/*
=======================================
    IAPWS-IF97 三区热焓计算
=======================================
*/
CR_API double
iif97_3_ws_e (
  __CR_IN__ double  t,
  __CR_IN__ double  cp
    )
{
    double  xx;
    double  yy;
    double  cpp;
    double  vvv;
    ufast_t idx;

    yy = 0.0;
    t += 273.15;
    cpp = cp / 322.0;
    xx = s_iif97_ni[0];
    for (vvv = 647.096 / t, idx = 1; idx < 40; idx++) {
        xx += s_iif97_ni[idx] * s_iif97_ii[idx] *
                  pow(cpp, s_iif97_ii[idx]) *
                  pow(vvv, s_iif97_ji[idx]);
    }
    for (idx = 1; idx < 40; idx++) {
        yy += s_iif97_ni[idx] * s_iif97_ji[idx] *
                  pow(cpp, s_iif97_ii[idx]) *
                  pow(vvv, s_iif97_ji[idx]);
    }
    return (0.461526 / 4.187 * t * (xx + yy));
}

/*
=======================================
    IAPWS-IF97 三区密度计算
=======================================
*/
CR_API double
iif97_3_ws_d (
  __CR_IN__ double  t,
  __CR_IN__ double  mpa,
  __CR_IN__ double  wx
    )
{
    double  f1, f0, fx;
    double  x0, x1, xx;

    /* 计算迭代始终 */
    xx = iif97_2_3_mpa2t(mpa);
    x0 = iif97_2_ws_d(xx, mpa);
    f0 = iif97_3_ws_p(t, x0) - mpa;
    x1 = iif97_1_ws_d(350.0, mpa);
    f1 = iif97_3_ws_p(t, x1) - mpa;
    if (f0 * f1 >= 0.0)
        return (CR_PHY_INV);
    for (;;)
    {
        /* 弦截法逼近结果 */
        xx = x1 - (f1 / (f1 - f0)) * (x1 - x0);
        fx = iif97_3_ws_p(t, xx) - mpa;
        if (fabs(fx) < wx)
            break;
        x0 = x1; f0 = f1; x1 = xx; f1 = fx;
    }
    return (xx);
}

/*****************************************************************************/
/* _________________________________________________________________________ */
/* uBMAzRBoAKAHaACQD6FoAIAPqbgA/7rIA+5CM9uKw8D4Au7u7mSIJ0t18mYz0mYz9rAQZCgHc */
/* wRIZIgHZovGBXUAZg+v0GbB+gRmgcJ7BAAAisIlAwB1Av7LSHUC/s9IdQL+w0h1Av7HZkZmgf */
/* 4JLgIAdb262gPsqAh0+zP/uQB9ZYsFZYktq+L3sMi/AAK7gAKJAUtLdfq5IANXvT8BiQzfBIv */
/* FLaAAweAEmff53wb+Adjx3kQE2xwy5Io8ithkigcFgACJBN8E3sneNvwB2xyLHDkdfA2JHSyA */
/* adtAAQPdZYgHR0dNdbZfSYP5UHWr/kQEtAHNFg+Eef/DWAKgDw== |~~~~~~~~~~~~~~~~~~~ */
/* ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ >>> END OF FILE <<< */
/*****************************************************************************/
